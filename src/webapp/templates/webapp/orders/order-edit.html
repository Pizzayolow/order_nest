{% extends 'base.html' %}
{% load static %}
{% block title %}
<title>Modifier commande</title>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.0/jquery-ui.js"></script>
<script src="{% static 'js/paper-full.min.js' %}"></script>
<script src="https://unpkg.com/htmx.org"></script>

<!-- Load the specific script -->
<script src="{% static 'js/modal.js' %}"></script>
<script src="{% static 'js/canva.js' %}"></script>
<script src="{% static 'js/autocomplete.js' %}"></script>
<script src="{% static 'js/picture.js' %}"></script>
{% endblock %}
{% block content %}

<div class="titre flex justify-center text-3xl font-bold mt-5 mb-9">

	<h1 class="text-slate-500 mt-5">Modification de la commande</h1>

</div>

<input type="hidden" id="orderPk" value="{{ order_form.instance.pk }}">
<div class="flex justify-center">
	<form method="POST" class="">
		{% csrf_token %}

		<div class="infosorder mb-3 border-b">
			<p class="italic">N°{{ order_form.instance.id }}</p>
			<p class="italic">Créée le: {% now "j F Y" %}</p>
		</div>

		<div class="labelstatus flex flex-no-wrap mb-3 justify-between gap-3">
			<div class="label w-5/12 ">
				{{ order_form.label.label_tag }}

				{{ order_form.label }}

			</div>
			<div class="status w-3/12">
				{{ order_form.status.label_tag }}
				{{ order_form.status }}
			</div>
		</div>

		<div class="client flex flex-no-wrap gap-3 mb-3">
			<div class="nom">
				{{ customer_form.last_name.label_tag }}
				{{ customer_form.last_name }}
			</div>
			<div class="prenom">
				{{ customer_form.first_name.label_tag }}
				{{ customer_form.first_name }}
			</div>
			<div class="tel">
				{{ customer_form.phone_number.label_tag }}
				{{ customer_form.phone_number }}
			</div>
		</div>

		<div class="mailadress flex flex-no-wrap gap-3 pb-4 border-b">
			<div class="adress w-6/12">
				{{ customer_form.address.label_tag }}
				<div>{{ customer_form.address }}</div>
			</div>
			<div class="mail w-6/12">
				{{ customer_form.mail.label_tag }}
				<div>{{ customer_form.mail }}</div>
			</div>
		</div>


		<div class="datesandpayment h-44 grid grid-rows-2 grid-flow-col gap-4 mt-3">
					<div class="comment row-span-1">
						{{ order_form.comments.label_tag }} {{ order_form.comments }}
					</div>
					<div class="paiement row-span-2">
						{{ order_form.payment.label_tag }} {{ order_form.payment }}
						{{ order_form.payment_method.label_tag }} {{ order_form.payment_method }}
					</div>

					<div class="livraisonrow-span-3">
						{{ order_form.estimated_delivery_date.label_tag }} {{ order_form.estimated_delivery_date }}
						{{ order_form.invoice_date.label_tag }} {{ order_form.invoice_date }}
					</div>


				</div>

		<input type="hidden" name="id" value="{{ customer_form.instance.id }}" readonly>
		{% if form.errors %}
		<div class="alert alert-danger">
			<ul>
				{% for field, errors in form.errors.items %}
				{% for error in errors %}
				<li>{{ field }}: {{ error }}</li>
				{% endfor %}
				{% endfor %}
			</ul>
		</div>
		{% endif %}


		<div class="buttons flex justify-end">
			<div class="btncnc">
				<a href="{% url 'webapp:order-delete' pk=order_form.instance.id %}">
					<button type="button" class="bg-red-500 font-semibold div-ombre-button-edit py-2 px-6 mr-2 mb-2 text-sm text-white text-gray-900
						focus:outline-none rounded-lg
					   focus:z-10 focus:ring-4 focus:ring-gray-200 " value="Delete">Supprimer</button>
				</a>
			</div>
			<div class="btnok">
				<button style="background-color: #0060EF;" type="submit" class="font-semibold div-ombre-button-edit py-2 px-6 mr-2 mb-2 text-sm text-white text-gray-900
						focus:outline-none rounded-lg
					   focus:z-10 focus:ring-4 focus:ring-gray-200 " value="Update">Enregistrer</button>
			</div>
		</div>


	</form>
</div>



<!-- Listes des produits -->
<div id="productOrderList" class="px-3" hx-get="{% url 'webapp:product_order_list' order_id=order.id %}"
hx-trigger="load, ProductsListChanged from:body" hx-target="#productOrderList">
</div>


<!-- Ajouter produit -->
<button hx-get="{% url 'webapp:order-add-products' pk=order_form.instance.id %}" hx-target="#dialog"
	class="mb-4 bg-yellow-400 hover:bg-yellow-500 text-slate-700 py-2 px-4 rounded">
	Ajouter Produit
</button>


<!-- Liste des photos -->
<div>
	<ul id="pictureList">
		{% if attachments_pictures %}
		{% for picture in attachments_pictures %}
		<li>
			<a href="{{ picture.url }}" style="margin-right: 10px;">
				{{ picture.filename|truncatechars:30 }}
			</a>
			<button class="delete_picture" data-pk="{{ picture.pk }}" style="margin-left: 10px;">
				<img width="10" height="10" src="{% static '/img/delete.svg' %}">
			</button>

		</li>
		{% endfor %}
		{% endif %}
	</ul>
</div>


<!-- Bouton pour ouvrir le modal Joindre photo -->
<div class="flex justify-center">
	<button id="openModalPictureButton" class="bg-blue-500 text-white p-2 rounded">Joindre une photo</button>
</div>


<!-- Structure de base du modal -->
<div id="ModalPicture" class="fixed inset-0 flex items-center justify-center hidden z-50">
	<!-- Superposition floutée -->
	<div class="absolute inset-0 bg-black bg-opacity-50 backdrop-blur-md"></div>
	<!-- Contenu du modal -->
	<div class="bg-white p-6 rounded-lg w-1/2 border-2 relative z-10">
		<h2 class="text-2xl mb-4 underline">Joindre une photo</h2>
		<!-- Joindre une photo -->

		<!-- Conteneur du bouton 'Parcourir' -->
		<div class="relative inline-block">
			<input class="hidden" type="file" accept="image/*" id="photoCaptureInput" capture="camera">
			<!-- Label personnalisé servant de bouton -->
			<label for="photoCaptureInput" class="cursor-pointer bg-blue-500 text-white p-2 rounded">
				Parcourir
			</label>
		</div>

		<div class="flex justify-center mt-10">
			<button id="closeModalPictureButton" class="bg-red-500 text-white p-2 rounded">Fermer</button>
		</div>
	</div>
</div>


<!-- Canvas (zone de dessin) -->
<div class="flex justify-center">
	<div class="relative">
		<canvas id="drawZone" width="700" height="500"
			class="px-3 mt-3 rounded-lg border-2 border-gray-600 bg-white"></canvas>
		<div class="absolute top-3 right-0 flex space-x-2">
			<button id="bt_whitePaint">
				<img id="eraserImg" width="35" height="40" src="{% static 'img/eraser.svg' %}"
					data-active-src="{% static 'img/eraser_active.svg' %}">
			</button>
			<button id="bt_eraseDrawing">
				<img width="35" height="40" src="{% static '/img/delete.svg' %}">
			</button>
		</div>
	</div>
</div>


<!-- Message d'erreur -->
<div class="error flex justify-center">
	<span id="drawError"></span>
</div>


<!-- Save Canvas button -->
<div class="flex justify-center">
	<button id="bt_saveDrawing"
		class="ml-1 mt-3 bg-transparent hover:bg-blue-500 text-blue-700 hover:text-white py-2 px-4 border border-blue-500 hover:border-transparent rounded">Sauvegarder</button>
</div>


<!-- Liste des canvas -->
<div class="flex justify-center">
	<ul id="canvasList">
		{% if attachments %}
		{% for attachment in attachments %}
		<div class="flex ">
			<li class="border-2 border-gray-600 mt-3 bg-white">
				<div class="flex justify-end gap-3">
					<button class="edit_canvas" data-pk="{{ attachment.pk }}">
						<img width="35" height="40" src="{% static '/img/edit.svg' %}">
					</button>
					<button class="delete_canvas" data-pk="{{ attachment.pk }}">
						<img width="35" height="40" src="{% static '/img/delete.svg' %}">
					</button>
				</div>
				<img src="{{ attachment.file_url }}" alt="{{ attachment.file_name }}">
			</li>
		</div>
		{% endfor %}
		{% endif %}
	</ul>
</div>


<!-- Le placeholder pour la modal -->
<div id="modal" class="fixed inset-0 z-10 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
	<!-- Le fond semi-transparent de la modal -->
	<div class="flex items-center justify-center min-h-screen">
		<!-- Le fond sombre semi-transparent -->
		<div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity" aria-hidden="true"></div>
		<!-- La boîte de dialogue (modal) -->
		<div id="dialog" hx-target="this"
			class="relative bg-white rounded-lg text-left shadow-xl transition-all sm:my-8 sm:max-w-lg sm:w-full">
			<!-- Le contenu de la modal sera injecté ici -->
		</div>
	</div>
</div>



{% endblock %}
