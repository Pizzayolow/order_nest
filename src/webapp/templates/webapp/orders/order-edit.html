{% extends 'base.html' %}
{% load static %}
{% block title %}
<title>Modifier commande</title>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.0/jquery-ui.js"></script>
<script src="{% static 'js/paper-full.min.js' %}"></script>
<script src="https://unpkg.com/htmx.org"></script>

<!-- Load the specific script -->
<script src="{% static 'js/modal.js' %}"></script>
<script src="{% static 'js/canva.js' %}"></script>
<script src="{% static 'js/autocomplete.js' %}"></script>
<script src="{% static 'js/picture.js' %}"></script>

<link href="https://fonts.googleapis.com/css2?family=VotreFamilleDePolices:wght@400&display=swap" rel="stylesheet">

{% endblock %}
{% block content %}

<div class="titre flex justify-center text-3xl font-bold mt-5 mb-9">

	<h1 class="title text-slate-500 mt-5">Modification de la commande</h1>

</div>

<input type="hidden" id="orderPk" value="{{ order_form.instance.pk }}">
<div class="flex justify-center">
	<div class="w-full max-w-4xl px-4 sm:px-6 md:px-8 ">
		<form method="POST" class="">
			{% csrf_token %}
			<!-- Titre -->
			<div class="subtitle infosorder mb-5">
				<p>N°{{ order_form.instance.id }}</p>
				<p>Créée le: {% now "j F Y" %}</p>
			</div>
			<div class="border-b"></div>
			<!-- libellé et status  -->
			<div class="labelstatus flex flex-no-wrap gap-5 mt-5">
				<div class="label w-7/12">
					{{ order_form.label.label_tag }}
					<div class="mt-2"></div>
					{{ order_form.label }}

				</div>
				<div class="status w-3/12 ml-auto">
					{{ order_form.status.label_tag }}
					<div class="mt-2"></div>
					{{ order_form.status }}
				</div>
			</div>
			<div class="border-b mb-5 mt-5"></div>
			<!-- Clients -->
			<div class="client flex flex-no-wrap gap-8">
				<div class="nom w-4/12">
					{{ customer_form.last_name.label_tag }}
					<div class="mt-2"></div>
					{{ customer_form.last_name }}
				</div>
				<div class="prenom w-4/12">
					{{ customer_form.first_name.label_tag }}
					<div class="mt-2"></div>
					{{ customer_form.first_name }}
				</div>
				<div class="tel w-3/12 ml-auto">
					{{ customer_form.phone_number.label_tag }}
					<div class="mt-2"></div>
					{{ customer_form.phone_number }}
				</div>
			</div>
			<!-- Coordonées : adresse & mail -->
			<div class="mailadress flex flex-no-wrap pb-4 mt-3">
				<div class="adress w-6/12 mr-10">
					{{ customer_form.address.label_tag }}
					<div class="mt-2"></div>
					<div>{{ customer_form.address }}</div>
				</div>
				<div class="mail w-6/12 ml-auto">
					{{ customer_form.mail.label_tag }}
					<div class="mt-2"></div>
					<div>{{ customer_form.mail }}</div>
				</div>
			</div>

			<div class="border-b mb-5 mt-5"></div>

			<div class="datesandpayment h-44 grid grid-rows-2 grid-flow-col mb-5">
				<!-- champ commentaire -->
				<div class="comment row-span-1">
				  {{ order_form.comments.label_tag }}
				  <div class="mt-2"></div>
				  {{ order_form.comments }}
				</div>
				<!-- champs paiements -->
				<div class="paiement row-span-2 ml-14"> <!-- ajusté ici -->
				  {{ order_form.payment.label_tag }}
				  <div class="mt-2"></div>
				  {{ order_form.payment }}
				  <div class="mt-2"></div>
				  {{ order_form.payment_method.label_tag }}
				  <div class="mt-2"></div>
				  {{ order_form.payment_method }}
				</div>
				<!-- champ livraisons et facturation -->
				<div class="livraison row-span-2 justify-self-end"> <!-- ajusté ici -->
				  {{ order_form.estimated_delivery_date.label_tag }}
				  <div class="mt-2"></div>
				  {{ order_form.estimated_delivery_date }}
				  <div class="mt-2"></div>
				  {{ order_form.invoice_date.label_tag }}
				  <div class="mt-2"></div>
				  {{ order_form.invoice_date }}
				</div>
			  </div>
			  

			<input type="hidden" name="id" value="{{ customer_form.instance.id }}" readonly>
			{% if form.errors %}
			<div class="alert alert-danger">
				<ul>
					{% for field, errors in form.errors.items %}
					{% for error in errors %}
					<li>{{ field }}: {{ error }}</li>
					{% endfor %}
					{% endfor %}
				</ul>
			</div>
			{% endif %}


			<div class="buttons flex justify-end">
				<div class="btncnc">
					<a href="{% url 'webapp:order-delete' pk=order_form.instance.id %}">
						<button style="background-color: #FF4E27; border-radius: 10px;" type="button" class="w-32 text-lg div-ombre-button-navbar-logout py-2 px-4 mr-7 mb-2 text-sm text-white 
						focus:outline-none
					   focus:z-10 focus:ring-4 focus:ring-gray-200" value="Delete">Supprimer</button>
					</a>
				</div>
				<div class="btnok">
					<button style="background-color: #0060EF; border-radius: 10px;" type="submit" class="w-32 text-lg div-ombre-button-edit py-2 px-4 mb-2 text-sm text-white
						focus:outline-none
					   focus:z-10 focus:ring-4 focus:ring-gray-200
					   mb-5" value="Update">Enregistrer</button>
				</div>
			</div>
			<hr>
		</form>


		<!-- Conteneur pour la liste des produits -->
		<div class="titre flex justify-left text-2xl font-bold mt-5 mb-3">
			<h1 class="title text-slate-500 mt-5">Liste des produits</h1>
		
		</div>
		<div id="productOrderList" hx-get="{% url 'webapp:product_order_list' order_id=order.id %}"
			hx-trigger="load, ProductsListChanged from:body" hx-target="#productOrderList">
			<!-- Le contenu de la liste des produits sera ici -->
		</div>

		<!-- Conteneur pour le bouton, aligné en bas à droite -->
		<div class="flex justify-end mt-auto">
			<button style="background-color: #0060EF; border-radius: 10px;"
				hx-get="{% url 'webapp:order-add-products' pk=order_form.instance.id %}" hx-target="#dialog" class="w-32 text-sm div-ombre-button-edit py-2 px-4 mb-2 text-sm text-white
					focus:outline-none
				   focus:z-10 focus:ring-4 focus:ring-gray-200 mb-5">
				Ajouter Produit
			</button>
		</div>
		<hr>



		<!-- Liste des photos -->
		<div class="titre flex justify-left text-2xl font-bold mt-5 mb-3">
			<h1 class="title text-slate-500 mt-5">Liste des photos</h1>
		</div>
		<div>
			<ul id="pictureList">
				{% if attachments_pictures %}
				{% for picture in attachments_pictures %}
				<li>
					<a href="{{ picture.url }}" style="margin-right: 10px;">
						{{ picture.filename|truncatechars:30 }}
					</a>
					<button class="delete_picture" data-pk="{{ picture.pk }}" style="margin-left: 10px;">
						<img width="10" height="10" src="{% static '/img/delete.svg' %}">
					</button>

				</li>
				{% endfor %}
				{% endif %}
			</ul>
		</div>


		<!-- Bouton pour ouvrir le modal Joindre photo -->
		<div class="flex justify-end">
			<button style="background-color: #0060EF; border-radius: 10px;"
			id="openModalPictureButton" class="w-32 text-sm div-ombre-button-edit py-2 px-4 mb-2 text-sm text-white
			focus:outline-none
		   focus:z-10 focus:ring-4 focus:ring-gray-200">
				Joindre photo
			</button>
		</div>



	</div>
</div>







<!-- Structure de base du modal -->
<div id="ModalPicture" class="fixed inset-0 flex items-center justify-center hidden z-50">
	<!-- Superposition floutée -->
	<div class="absolute inset-0 bg-black bg-opacity-50 backdrop-blur-md"></div>
	<!-- Contenu du modal -->
	<div style="max-width: 800px; width: 90%;" class="bg-white p-6 rounded-lg mx-auto border-2 relative z-10">
		<h2 class="text-2xl mb-4 underline">Joindre une photo</h2>
		<!-- Joindre une photo -->

		<!-- Conteneur du bouton 'Parcourir' -->
		<div class="relative inline-block">
			<input class="hidden" type="file" accept="image/*" id="photoCaptureInput" capture="camera">
			<!-- Label personnalisé servant de bouton -->
			<label for="photoCaptureInput" class="cursor-pointer bg-blue-500 text-white p-2 rounded">
				Parcourir
			</label>
		</div>

		<div class="flex justify-center mt-10">
			<button id="closeModalPictureButton" class="bg-red-500 text-white p-2 rounded">Fermer</button>
		</div>
	</div>
</div>


<!-- Canvas (zone de dessin) -->

<div class="flex justify-center">
	<div class="relative">
		<canvas id="drawZone" width="700" height="500"
			class="px-3 mt-3 rounded-lg border-2 border-gray-600 bg-white"></canvas>
		<div class="absolute top-3 right-0 flex space-x-2">
			<button id="bt_whitePaint">
				<img id="eraserImg" width="35" height="40" src="{% static 'img/eraser.svg' %}"
					data-active-src="{% static 'img/eraser_active.svg' %}">
			</button>
			<button id="bt_eraseDrawing">
				<img width="35" height="40" src="{% static '/img/delete.svg' %}">
			</button>
		</div>
	</div>
</div>


<!-- Message d'erreur -->
<div class="error flex justify-center">
	<span id="drawError"></span>
</div>


<!-- Save Canvas button -->
<div class="flex justify-center">
	<button id="bt_saveDrawing"
		class="ml-1 mt-3 bg-transparent hover:bg-blue-500 text-blue-700 hover:text-white py-2 px-4 border border-blue-500 hover:border-transparent rounded">Sauvegarder</button>
</div>


<!-- Liste des canvas -->
<div class="flex justify-center">
	<ul id="canvasList">
		{% if attachments %}
		{% for attachment in attachments %}
		<div class="flex ">
			<li class="border-2 border-gray-600 mt-3 bg-white">
				<div class="flex justify-end gap-3">
					<button class="edit_canvas" data-pk="{{ attachment.pk }}">
						<img width="35" height="40" src="{% static '/img/edit.svg' %}">
					</button>
					<button class="delete_canvas" data-pk="{{ attachment.pk }}">
						<img width="35" height="40" src="{% static '/img/delete.svg' %}">
					</button>
				</div>
				<img src="{{ attachment.file_url }}" alt="{{ attachment.file_name }}">
			</li>
		</div>
		{% endfor %}
		{% endif %}
	</ul>
</div>


<!-- Le placeholder pour la modal -->
<div id="modal" class="fixed inset-0 flex items-center justify-center z-50 hidden" aria-labelledby="modal-title"
	role="dialog" aria-modal="true">
	<!-- Le fond semi-transparent de la modal -->
	<div class="absolute inset-0 bg-black bg-opacity-50 backdrop-blur-md"></div>
	<!-- La boîte de dialogue (modal) -->
	<div id="dialog" hx-target="this" class="bg-white p-6 rounded-lg border-2 z-10 m-auto"
		style="max-width: 800px; width: 90%;">
		<!-- Le contenu de la modal sera injecté ici -->
	</div>
</div>





{% endblock %}
